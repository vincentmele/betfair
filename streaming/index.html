


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lightweight, super fast (uses c libraries) pythonic wrapper for Betfair API-NG.">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.2">
    
    
      
        <title>Streaming - betfairlightweight</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.25b81cc6.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.80a78273.min.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="blue-grey" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#streaming" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="betfairlightweight" class="md-header-nav__button md-logo" aria-label="betfairlightweight">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            betfairlightweight
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Streaming
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/liampauling/betfair" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    liampauling/betfair
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="betfairlightweight" class="md-nav__button md-logo" aria-label="betfairlightweight">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    betfairlightweight
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/liampauling/betfair" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    liampauling/betfair
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../quickstart/" title="QuickStart" class="md-nav__link">
      QuickStart
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../endpoints/" title="Endpoints" class="md-nav__link">
      Endpoints
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Streaming
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Streaming" class="md-nav__link md-nav__link--active">
      Streaming
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-streaming" class="md-nav__link">
    Why streaming?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#market" class="md-nav__link">
    Market
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#order" class="md-nav__link">
    Order
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#historical" class="md-nav__link">
    Historical
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snap" class="md-nav__link">
    Snap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resubscribe" class="md-nav__link">
    Resubscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    Error Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listener" class="md-nav__link">
    Listener
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../advanced/" title="Advanced Usage" class="md-nav__link">
      Advanced Usage
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../help/" title="Help" class="md-nav__link">
      Help
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-streaming" class="md-nav__link">
    Why streaming?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#market" class="md-nav__link">
    Market
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#order" class="md-nav__link">
    Order
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#historical" class="md-nav__link">
    Historical
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#snap" class="md-nav__link">
    Snap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resubscribe" class="md-nav__link">
    Resubscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    Error Handling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listener" class="md-nav__link">
    Listener
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging" class="md-nav__link">
    Logging
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="streaming">Streaming</h1>
<h3 id="why-streaming">Why streaming?</h3>
<p>If your aim is to take a snapshot of horse markets 3 minutes before the off and at post time, polling (listMarketBook) is a good solution. You will only hit the Betfair API endpoint 2 times per market.
But if you want to gather, process and react to data more frequently (e.g. in-play horse racing), polling is inefficient and the reason lies in the way HTTP works. Every time you hit a Betfair API endpoint:</p>
<ul>
<li>Your machine establishes a new connection with the Betfair server.</li>
<li>It sends an HTTP request and receives and HTTP response.</li>
<li>HTTP requests/responses carry headers, so more data is sent/received.</li>
</ul>
<p>Streaming is more efficient because:</p>
<ul>
<li>The connection gets established once.</li>
<li>From that moment, data keeps flowing from Betfair to your machine.</li>
<li>There are no data overheads as you would have with polling / HTTP.</li>
<li>This results in faster data and less CPU from your machine (and Betfair's)</li>
</ul>
<p>The full docs can be found <a href="https://docs.developer.betfair.com/display/1smk3cen4v3lu3yomq5qye0ni/Exchange+Stream+API">here</a></p>
<h3 id="market">Market</h3>
<p>A market stream can be created like so:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">import</span> <span class="nn">betfairlightweight</span>
<span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">streaming_market_filter</span><span class="p">,</span>
    <span class="n">streaming_market_data_filter</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="s2">&quot;appKey&quot;</span><span class="p">)</span>
<span class="n">trading</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>

<span class="c1"># create queue</span>
<span class="n">output_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

<span class="c1"># create stream listener</span>
<span class="n">listener</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">(</span><span class="n">output_queue</span><span class="o">=</span><span class="n">output_queue</span><span class="p">)</span>

<span class="c1"># create stream</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_stream</span><span class="p">(</span><span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">)</span>

<span class="c1"># create filters (GB WIN racing)</span>
<span class="n">market_filter</span> <span class="o">=</span> <span class="n">streaming_market_filter</span><span class="p">(</span>
    <span class="n">event_type_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;7&quot;</span><span class="p">],</span> <span class="n">country_codes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GB&quot;</span><span class="p">],</span> <span class="n">market_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WIN&quot;</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">market_data_filter</span> <span class="o">=</span> <span class="n">streaming_market_data_filter</span><span class="p">(</span>
    <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EX_BEST_OFFERS&quot;</span><span class="p">,</span> <span class="s2">&quot;EX_MARKET_DEF&quot;</span><span class="p">],</span> <span class="n">ladder_levels</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>

<span class="c1"># subscribe</span>
<span class="n">streaming_unique_id</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">subscribe_to_markets</span><span class="p">(</span>
    <span class="n">market_filter</span><span class="o">=</span><span class="n">market_filter</span><span class="p">,</span>
    <span class="n">market_data_filter</span><span class="o">=</span><span class="n">market_data_filter</span><span class="p">,</span>
    <span class="n">conflate_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># send update every 1000ms</span>
<span class="p">)</span>

<span class="c1"># start stream in a new thread (in production would need err handling)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># check for updates in output queue</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">market_books</span> <span class="o">=</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">market_books</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">market_book</span> <span class="ow">in</span> <span class="n">market_books</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="n">market_book</span><span class="p">,</span>
            <span class="n">market_book</span><span class="o">.</span><span class="n">streaming_unique_id</span><span class="p">,</span>  <span class="c1"># unique id of stream (returned from subscribe request)</span>
            <span class="n">market_book</span><span class="o">.</span><span class="n">streaming_update</span><span class="p">,</span>  <span class="c1"># json update received</span>
            <span class="n">market_book</span><span class="o">.</span><span class="n">market_definition</span><span class="p">,</span>  <span class="c1"># streaming definition, similar to catalogue request</span>
            <span class="n">market_book</span><span class="o">.</span><span class="n">publish_time</span><span class="p">,</span>  <span class="c1"># betfair publish time of update</span>
        <span class="p">)</span>
</code></pre></div>


<h3 id="order">Order</h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The order stream does not include matched positions, these can be found by making a getCurrentOrders request. However 'price point' matched backs and matched lays are stored in the order cache in matched_lays / matched_backs.</p>
</div>
<p>Order stream is similar to market:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">import</span> <span class="nn">betfairlightweight</span>
<span class="kn">from</span> <span class="nn">betfairlightweight.filters</span> <span class="kn">import</span> <span class="n">streaming_order_filter</span>

<span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">app_key</span><span class="o">=</span><span class="s2">&quot;appKey&quot;</span><span class="p">)</span>
<span class="n">trading</span><span class="o">.</span><span class="n">login</span><span class="p">()</span>

<span class="c1"># create queue</span>
<span class="n">output_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

<span class="c1"># create stream listener</span>
<span class="n">listener</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">(</span><span class="n">output_queue</span><span class="o">=</span><span class="n">output_queue</span><span class="p">)</span>

<span class="c1"># create stream</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_stream</span><span class="p">(</span><span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">)</span>

<span class="c1"># create filters (GB WIN racing)</span>
<span class="n">order_filter</span> <span class="o">=</span> <span class="n">streaming_order_filter</span><span class="p">()</span>

<span class="c1"># subscribe</span>
<span class="n">streaming_unique_id</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">subscribe_to_orders</span><span class="p">(</span>
    <span class="n">order_filter</span><span class="o">=</span><span class="n">order_filter</span><span class="p">,</span>
    <span class="n">conflate_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># send update every 1000ms</span>
<span class="p">)</span>

<span class="c1"># start stream in a new thread (in production would need err handling)</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># check for updates in output queue</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">current_orders</span> <span class="o">=</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">current_orders</span><span class="p">)</span>
</code></pre></div>


<h3 id="historical">Historical</h3>
<p>Betfairlightweight can also handle historical streaming data that has been purchased from <a href="https://historicdata.betfair.com/#/home">Betfair</a> or collected yourself. </p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">trading</span> <span class="o">=</span> <span class="n">betfairlightweight</span><span class="o">.</span><span class="n">APIClient</span><span class="p">(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>

    <span class="c1"># create listener</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">HistoricalListener</span><span class="p">(</span><span class="n">max_latency</span><span class="o">=</span><span class="mf">1e100</span><span class="p">)</span>

    <span class="c1"># create historical stream, update file_path to file location</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_stream</span><span class="p">(</span>
        <span class="n">file_path</span><span class="o">=</span><span class="s2">&quot;/tmp/BASIC-1.132153978&quot;</span><span class="p">,</span>
        <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># start stream</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stream</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>


<p>The historical stream can be used in the same way as the market/order stream allowing backtesting / market processing.</p>
<p>It is also possible to return a generator instead which can be easier to use (no threads) and uses less ram:</p>
<div class="codehilite"><pre><span></span><code>    <span class="c1"># create historical generator stream, update directory to file location</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">trading</span><span class="o">.</span><span class="n">streaming</span><span class="o">.</span><span class="n">create_historical_generator_stream</span><span class="p">(</span>
        <span class="n">file_path</span><span class="o">=</span><span class="s2">&quot;/tmp/BASIC-1.132153978&quot;</span><span class="p">,</span>
        <span class="n">listener</span><span class="o">=</span><span class="n">listener</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># create genertaor</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">g</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">get_generator</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">market_books</span> <span class="ow">in</span> <span class="n">g</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">market_books</span><span class="p">)</span>

<span class="p">[</span><span class="o">&lt;</span><span class="n">MarketBook</span><span class="o">&gt;</span><span class="p">]</span>
<span class="o">..</span>
</code></pre></div>


<h3 id="snap">Snap</h3>
<p>Instead of waiting for an update you can snap the listener to get an up to date version of the data.</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">market_books</span> <span class="o">=</span> <span class="n">listener</span><span class="o">.</span><span class="n">snap</span><span class="p">(</span>
        <span class="n">market_ids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;1.12345323&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>


<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The streaming unique id is returned in the marketBook / orderBook which allows multiple streams to be differentiated if multiple streams feed into the same queue.</p>
<p><code>market_book.streaming_unique_id</code></p>
</div>
<h3 id="resubscribe">Resubscribe</h3>
<p>If you have lost connection and need to resubscribe (prevents a full image being sent) you can provide the following:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">streaming_unique_id</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">subscribe_to_markets</span><span class="p">(</span>
        <span class="n">market_filter</span><span class="o">=</span><span class="n">market_filter</span><span class="p">,</span>
        <span class="n">market_data_filter</span><span class="o">=</span><span class="n">market_data_filter</span><span class="p">,</span>
        <span class="n">conflate_ms</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>  <span class="c1"># send update every 1000ms</span>
        <span class="n">initial_clk</span><span class="o">=</span><span class="n">listener</span><span class="o">.</span><span class="n">initial_clk</span><span class="p">,</span>
        <span class="n">clk</span><span class="o">=</span><span class="n">listener</span><span class="o">.</span><span class="n">clk</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>


<h3 id="error-handling">Error Handling</h3>
<p>When used in production it is recommended not to start the stream in a new thread and forgot about it, it will break, errors need to be caught. </p>
<p>Please see the example <a href="https://github.com/liampauling/betfair/blob/master/examples/examplestreamingerrhandling.py">examplestreamingerrhandling.py</a></p>
<p>Sometimes betfair will suspend the stream via the use of a status=503 update, more info <a href="https://docs.developer.betfair.com/display/1smk3cen4v3lu3yomq5qye0ni/Exchange+Stream+API#ExchangeStreamAPI-StreamAPIStatus-latency">here</a>, when the stream is receiving this update the <code>listener.status</code> will be updated:</p>
<div class="codehilite"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">listener</span><span class="o">.</span><span class="n">status</span>
<span class="mi">503</span>
</code></pre></div>


<h3 id="listener">Listener</h3>
<p>You can create a custom listener by overriding the listener class:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">betfairlightweight</span>


<span class="k">class</span> <span class="nc">MyListener</span><span class="p">(</span><span class="n">betfairlightweight</span><span class="o">.</span><span class="n">StreamListener</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">raw_data</span><span class="p">)</span>


<span class="n">custom_listener</span> <span class="o">=</span> <span class="n">MyListener</span><span class="p">()</span>
</code></pre></div>


<h3 id="logging">Logging</h3>
<p>In order to debug the stream update the logging level to DEBUG:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</code></pre></div>


<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>By default <code>max_latency</code> is set to 0.5, this means a warning will be logged if the latency between the publishTime and your machines time is greater than this number. Often you will need to check that your clock is up to date, however this can be removed by setting <code>max_latency=None</code> when initializing the listener.</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../endpoints/" title="Endpoints" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Endpoints
              </div>
            </div>
          </a>
        
        
          <a href="../advanced/" title="Advanced Usage" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Advanced Usage
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.592d4e23.min.js"></script>
      <script src="../assets/javascripts/bundle.806ca5c4.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.01088dc6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>